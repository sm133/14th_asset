<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recent Activity - Asset Management</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <style>
    body { background:#f5f7fa; font-family:'Roboto',sans-serif; }
    header.hero { background:linear-gradient(135deg,#1976d2,#1565c0); color:#fff; padding:32px 0 28px; margin-bottom:24px; box-shadow:0 4px 18px rgba(0,0,0,.15); }
    header.hero h4 { margin:0 0 6px; font-weight:400; letter-spacing:.5px; }
    header.hero p { margin:0; opacity:.9; }
    .activity-card { border-radius:14px; background:#fff; padding:18px 22px 6px; margin-bottom:16px; box-shadow:0 3px 12px rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.05); position:relative; }
    .activity-card:hover { box-shadow:0 6px 22px rgba(0,0,0,.12); }
    .asset-header { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
    .asset-name { font-size:1.15rem; font-weight:500; color:#1e293b; margin:0; }
    .chip.cat-maint { background:#fee2e2; color:#b91c1c; }
    .chip.cat-test { background:#dcfce7; color:#166534; }
    .chip.small { height:22px; line-height:22px; font-size:.70rem; font-weight:500; }
    .event-row { display:flex; gap:16px; padding:10px 0 10px; border-top:1px solid #e2e8f0; }
    .event-row:first-of-type { border-top:none; }
    .event-date { width:110px; flex:0 0 auto; font-size:.8rem; text-transform:uppercase; letter-spacing:.5px; color:#475569; font-weight:600; }
    .event-body { flex:1; }
    .event-title { margin:0 0 2px; font-size:.95rem; font-weight:500; color:#334155; }
    .event-meta { margin:0 0 4px; font-size:.7rem; letter-spacing:.5px; color:#64748b; font-weight:600; }
    .event-notes { margin:0 0 8px; font-size:.8rem; color:#475569; }
    .status-badge { display:inline-block; padding:2px 8px; border-radius:20px; font-size:.65rem; font-weight:600; letter-spacing:.5px; background:#e2e8f0; color:#334155; }
    .status-badge.pass { background:#d1fae5; color:#065f46; }
    .status-badge.fail { background:#fee2e2; color:#991b1b; }
    .status-badge.partial { background:#fef3c7; color:#92400e; }
    .filter-card { background:#fff; padding:18px 20px; border-radius:14px; margin-bottom:24px; box-shadow:0 2px 10px rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.05); }
    .secondary-actions a { color:#fff; margin-right:16px; font-size:.9rem; display:inline-flex; align-items:center; gap:4px; }
    .empty { text-align:center; padding:60px 20px; background:#fff; border-radius:14px; border:1px dashed #cbd5e1; color:#64748b; }
    @media(max-width:700px){ .event-row { flex-direction:column; } .event-date { width:auto; } }
  </style>
</head>
<body>
  <header class="hero">
    <div class="container">
      <h4>Recent Activity</h4>
      <p>Combined maintenance and test activity from the past <span id="daysWindow">7</span> days.</p>
      <div class="secondary-actions" style="margin-top:10px;">
        <a href="dashboard-complete.html" class="btn-small blue lighten-1 waves-effect waves-light"><i class="material-icons left">dashboard</i>Dashboard</a>
      </div>
    </div>
  </header>
  <main class="container" style="margin-bottom:80px;">
    <div class="filter-card row" id="filtersRow">
      <div class="input-field col s12 m4">
        <select id="assetTypeFilter"><option value="">All Asset Types</option></select>
        <label>Asset Type</label>
      </div>
      <div class="input-field col s12 m3">
        <input type="number" id="daysBack" min="1" max="90" value="7" />
        <label class="active" for="daysBack">Days Back</label>
      </div>
      <div class="input-field col s12 m5">
        <input type="text" id="searchText" placeholder="Search assets or activity..." />
        <label class="active" for="searchText">Search</label>
      </div>
      <div class="col s12" style="margin-top:4px;">
        <a class="btn waves-effect" id="applyFiltersBtn"><i class="material-icons left">refresh</i>Apply</a>
        <a class="btn-flat" id="resetFiltersBtn">Reset</a>
      </div>
    </div>

    <div id="activityContainer"></div>
  </main>

  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/data-loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    async function initRecentActivity(){
      try {
        await loadAllData();
        buildTypeFilter();
        renderRecentActivity();
      } catch(e){
        console.error('Init recent activity failed', e);
        M.toast({html:'Failed loading data', classes:'red'});
      }
    }

    function buildTypeFilter(){
      const sel = document.getElementById('assetTypeFilter');
      const types = [...new Set(allAssets.map(a=>a.type).filter(Boolean))].sort();
      types.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
      M.FormSelect.init(sel);
    }

    function collectEvents(){
      const events = [];
      const assetMap = new Map(allAssets.map(a=>[a.id,a]));

      // Maintenance events
      maintenanceHistory.forEach(m=>{
        const asset = assetMap.get(m.assetId);
        if(!asset) return; // unknown asset
        const dt = parseDate(m.date);
        events.push({
          assetId: m.assetId,
          assetName: asset.name || m.assetId,
          assetType: asset.type || '',
          dateObj: dt,
          dateDisplay: m.date,
          category: 'Maintenance',
            // summary: `${m.type||'Maintenance'} - ${truncate(m.description,80)}`,
          summary: `${m.type||'Maintenance'}`,
          extra: m.description || '',
          meta: m.technician ? `By ${m.technician}` : '',
          raw: m
        });
      });

      // Test result events (group objects in testResultsHistory already unique per session)
      testResultsHistory.forEach(tr=>{
        const asset = assetMap.get(tr.assetId);
        if(!asset) return;
        const dt = parseDate(tr.date);
        events.push({
          assetId: tr.assetId,
          assetName: asset.name || tr.assetId,
          assetType: asset.type || '',
          dateObj: dt,
          dateDisplay: tr.date,
          category: 'Test',
          summary: lookupProcedureName(tr.procedureId) || 'Test',
          extra: (tr.notes||'').split(/[\n]/)[0],
          meta: buildTestMeta(tr),
          status: (tr.overallStatus||'').toLowerCase(),
          raw: tr
        });
      });
      return events;
    }

    function lookupProcedureName(id){
      const p = testProcedures.find(p=>p.id===id); return p ? p.name : '';
    }

    function buildTestMeta(tr){
      const techs = tr.technicians ? `Techs: ${tr.technicians}`:'';
      const cons = tr.contractors ? `Contractors: ${tr.contractors}`:'';
      return [techs,cons].filter(Boolean).join(' | ');
    }

    function truncate(str,len){ if(!str) return ''; if(str.length<=len) return str; return str.slice(0,len-1)+'â€¦'; }

    function normalizeSearchText(str){
      return (str||'').toLowerCase().replace(/[-_]/g,' ').replace(/\s+/g,' ').trim();
    }

    function renderRecentActivity(){
      const daysBack = parseInt(document.getElementById('daysBack').value,10) || 7;
      document.getElementById('daysWindow').textContent = daysBack;
      const typeFilter = document.getElementById('assetTypeFilter').value;
      const rawSearch = (document.getElementById('searchText').value||'');
      const searchNorm = normalizeSearchText(rawSearch);
      const now = new Date();
      const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (daysBack-1)); // inclusive of today

      let events = collectEvents();
      events = events.filter(ev=> ev.dateObj && ev.dateObj >= cutoff && ev.dateObj <= now);
      if(typeFilter) events = events.filter(ev=> ev.assetType === typeFilter);
      if(searchNorm){
        events = events.filter(ev=>{
          const assetNameN = normalizeSearchText(ev.assetName);
          const summaryN = normalizeSearchText(ev.summary);
            const extraN = normalizeSearchText(ev.extra);
          const metaN = normalizeSearchText(ev.meta);
          return assetNameN.includes(searchNorm) || summaryN.includes(searchNorm) || extraN.includes(searchNorm) || metaN.includes(searchNorm);
        });
      }

      // Group by asset
      const byAsset = new Map();
      events.forEach(ev=>{ if(!byAsset.has(ev.assetId)) byAsset.set(ev.assetId, { assetName: ev.assetName, assetType: ev.assetType, events: [] }); byAsset.get(ev.assetId).events.push(ev); });

      // Sort events within each asset desc by date
      byAsset.forEach(group=> group.events.sort((a,b)=> b.dateObj - a.dateObj));

      // Sort asset groups by most recent event
      const groups = Array.from(byAsset.values()).sort((a,b)=> b.events[0].dateObj - a.events[0].dateObj);

      const container = document.getElementById('activityContainer');
      container.innerHTML='';

      if(!groups.length){
        container.innerHTML = '<div class="empty">No activity found in selected window.</div>';
        return;
      }

      groups.forEach(g=>{
        const card = document.createElement('div');
        card.className='activity-card';
        const icon = g.assetType && g.assetType.toLowerCase().includes('generator') ? 'electrical_services' : 'precision_manufacturing';
        card.innerHTML = `
          <div class="asset-header">
            <i class="material-icons" style="color:#1976d2;">${icon}</i>
            <h6 class="asset-name">${g.assetName} <span style="font-weight:400; color:#64748b; font-size:.75rem;">${g.assetType||''}</span></h6>
          </div>
          <div class="events-wrapper"></div>
        `;
        const wrap = card.querySelector('.events-wrapper');
        g.events.forEach(ev=>{
          const statusBadge = ev.category==='Test' && ev.status ? `<span class="status-badge ${ev.status}">${ev.status}</span>`:'';
          const chipClass = ev.category==='Test' ? 'cat-test':'cat-maint';
          const extra = ev.extra ? `<p class="event-notes">${truncate(ev.extra,140)}</p>`:'';
          const rowHtml = `
            <div class="event-row" data-asset-id="${ev.assetId}" data-category="${ev.category}" data-procedure-id="${ev.raw.procedureId||''}" data-timestamp="${ev.raw.timestamp||''}">
              <div class="event-date">${ev.dateDisplay}</div>
              <div class="event-body">
                <p class="event-title"><span class="chip small ${chipClass}">${ev.category}</span> ${ev.summary} ${statusBadge}</p>
                ${ev.meta?`<p class="event-meta">${ev.meta}</p>`:''}
                ${extra}
              </div>
            </div>`;
          wrap.insertAdjacentHTML('beforeend', rowHtml);
        });
        container.appendChild(card);
      });

      // Attach click handlers after render
      container.querySelectorAll('.event-row').forEach(row=>{
        row.style.cursor='pointer';
        row.addEventListener('click', ()=> handleEventRowClick(row));
      });
    }

    function handleEventRowClick(row){
      const assetId = row.getAttribute('data-asset-id');
      const category = row.getAttribute('data-category');
      const procedureId = row.getAttribute('data-procedure-id');
      const timestamp = row.getAttribute('data-timestamp');
      if(!assetId){ return; }
      // Attempt to open dashboard (modular) in same tab with hash deep link
      const params = new URLSearchParams({ asset: assetId });
      if(category==='Test' && procedureId && timestamp){
        params.set('testTs', timestamp);
      }
      // Navigate to modular dashboard with hash for client-side to pick up
      window.location.href = `dashboard-modular.html#${params.toString()}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      initRecentActivity();
      document.getElementById('applyFiltersBtn').addEventListener('click', renderRecentActivity);
      document.getElementById('resetFiltersBtn').addEventListener('click', ()=>{
        document.getElementById('assetTypeFilter').value='';
        document.getElementById('daysBack').value='7';
        document.getElementById('searchText').value='';
        M.FormSelect.init(document.getElementById('assetTypeFilter'));
        renderRecentActivity();
      });
  document.getElementById('searchText').addEventListener('keyup', e=>{ if(e.key==='Enter') renderRecentActivity(); });
    });
  </script>
</body>
</html>
