<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Centre Asset Management - Complete Version</title>
    
    <!-- Material Design CSS -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    
    <style>
        /* Enhanced Professional Styling */
        body {
            background-color: #f5f7fa;
            font-family: 'Roboto', sans-serif;
        }
        
        /* Dashboard Header Enhancement */
        .dashboard-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(30deg);
        }
        
        .dashboard-header h3 {
            margin: 0 0 10px 0;
            font-weight: 300;
            font-size: 2.5rem;
            letter-spacing: 1px;
        }
        
        .dashboard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        /* Enhanced Statistics Cards */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: rgba(0,0,0,0.03);
            border-radius: 50%;
            transform: translate(20px, -20px);
        }
        
        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 5px;
            line-height: 1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        /* Enhanced Filter Section */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .filter-section h5 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #334155;
            font-weight: 500;
        }
        
        /* Enhanced Asset Cards */
        .asset-card {
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            background: white;
            position: relative;
            overflow: visible;
        }
        
        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .asset-card .card-content {
            padding: 20px;
        }
        
        .asset-card .card-title {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: #1e293b;
        }
        
        .asset-card p {
            margin: 8px 0;
            font-size: 0.95rem;
            color: #475569;
        }
        
        .asset-card p strong {
            color: #334155;
            font-weight: 500;
        }
        
        /* Status Colors Enhancement */
        .status-normal { 
            color: #10b981;
            font-weight: 500;
        }
        .status-in-maintenance { 
            color: #f59e0b;
            font-weight: 500;
        }
        .status-fault-shutdown { 
            color: #ef4444;
            font-weight: 500;
        }
        
        /* Maintenance Status Cards */
        .maintenance-due-soon {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, #fef3c7 0%, white 100%);
        }
        
        .maintenance-overdue {
            border-left: 4px solid #ef4444;
            background: linear-gradient(to right, #fee2e2 0%, white 100%);
        }
        
        /* Loading Spinner Enhancement */
        .loading-spinner {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        /* Modal Enhancements */
        .modal {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .modal .modal-content {
            padding: 30px;
        }
        
        .modal h4 {
            margin-top: 0;
            color: #1e293b;
            font-weight: 500;
        }
        
        .modal .modal-footer {
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Tabs Enhancement */
        .tabs {
            background-color: transparent;
            margin-bottom: 20px;
        }
        
        .tabs .tab a {
            color: #64748b;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        .tabs .tab a:hover, .tabs .tab a.active {
            color: #1976d2;
            background-color: rgba(25, 118, 210, 0.05);
        }
        
        .tabs .indicator {
            background-color: #1976d2;
            height: 3px;
        }
        
        /* Test Step Enhancement */
        .test-step {
            margin-bottom: 20px;
            padding: 20px;
            border-left: 4px solid #1976d2;
            background-color: #f8fafc;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .test-step:hover {
            background-color: #f1f5f9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .test-step.completed {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .test-step.failed {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .test-step h6 {
            margin-top: 0;
            color: #1e293b;
            font-weight: 500;
        }
        
        /* Fix dropdown positioning to prevent covering radio buttons */
        .test-step .input-field {
            margin-bottom: 0;
        }
        
        .test-step .select-wrapper {
            margin-bottom: 15px;
        }
        
        .test-step .select-dropdown {
            margin-bottom: 0;
        }
        
        /* Ensure proper spacing for radio buttons */
        .test-step-controls {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            margin-top: 15px;
        }
        
        .test-step-performer {
            flex: 1;
            min-width: 250px;
        }
        
        .test-step-result {
            flex: 0 0 auto;
            padding-top: 10px;
        }
        
        /* Image Modal Enhancement */
        #imageModal {
            max-width: 95%;
            max-height: 95%;
            width: auto;
            height: auto;
        }
        
        #imageModal .modal-content {
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #000;
        }
        
        .image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            background: #000;
            position: relative;
        }
        
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
        }
        
        /* Image modal footer styling */
        #imageModal .modal-footer {
            background-color: rgba(0,0,0,0.9);
            border-top: 1px solid #333;
            padding: 10px 24px;
            position: relative;
            z-index: 10;
        }
        
        #imageModal .modal-footer .btn-flat {
            color: white;
        }
        
        #imageModal .modal-footer .btn-flat:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        /* Zoom controls for image */
        .image-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }
        
        .image-controls .btn-floating {
            background-color: rgba(0,0,0,0.7);
        }
        
        .image-controls .btn-floating:hover {
            background-color: rgba(0,0,0,0.9);
        }
        
        /* Enhanced Asset Modal Styling */
        .asset-info-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 30px;
            margin: -30px -30px 30px -30px;
            position: relative;
            overflow: hidden;
        }
        
        .asset-info-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(-30deg);
        }
        
        .asset-info-header h4 {
            margin: 0;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }
        
        .asset-info-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }
        
        /* Info Cards in Modal */
        .info-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .info-card h6 {
            color: #1976d2;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 500;
        }
        
        /* Enhanced Test Procedure Cards */
        .procedure-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .procedure-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-3px);
        }
        
        .procedure-card .card-title {
            color: #1e293b;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .procedure-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
        }
        
        .meta-item i {
            color: #1976d2;
        }
        
        /* Test History Timeline */
        .test-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .test-timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e2e8f0;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #1976d2;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-item.passed::before {
            background: #10b981;
        }
        
        .timeline-item.failed::before {
            background: #ef4444;
        }
        
        .timeline-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Maintenance History Cards */
        .maintenance-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .maintenance-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .maintenance-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .maintenance-type.preventive {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .maintenance-type.corrective {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .maintenance-type.routine {
            background: #f0fdf4;
            color: #15803d;
        }
        
        /* Enhanced Dashboard Cards */
        .asset-type-icon {
            position: absolute;
            top: -10px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 24px;
            color: #1976d2;
        }
        
        /* Personnel fields styling */
        .personnel-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .personnel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .step-performer {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-timestamp {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Test Step Wizard Enhancement */
        .test-wizard-container {
            position: relative;
            min-height: 400px;
        }
        
        .test-wizard-progress {
            margin-bottom: 30px;
        }
        
        .test-wizard-step {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .test-wizard-step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .step-indicator-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #9e9e9e;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .step-indicator-item.completed {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }
        
        .step-indicator-item.active {
            background: #2196f3;
            border-color: #2196f3;
            color: white;
            transform: scale(1.2);
            animation: pulse 1s infinite;
        }
        
        .step-indicator-item.error {
            background: #f44336;
            border-color: #f44336;
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1.2); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.2); }
        }
        
        .wizard-navigation {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .step-validation-message {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .step-validation-message.error {
            background: #fef2f2;
            border-color: #f87171;
            color: #dc2626;
        }
        
        .step-validation-message i {
            font-size: 18px;
        }
        
        /* Enhanced personnel section for wizard mode */
        .personnel-step {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .personnel-step h5 {
            margin-top: 0;
            color: #1976d2;
        }
        
        /* Step summary card */
        .step-summary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .step-summary.completed {
            background: #f0fdf4;
            border-color: #10b981;
        }
        
        .step-summary.failed {
            background: #fef2f2;
            border-color: #ef4444;
        }
    </style>
    
    <!-- Google API Scripts -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <!-- Embed Google API configuration -->
    <script>
        const GOOGLE_CONFIG = {
            API_KEY: 'AIzaSyBKMeccFQLd_0Co5ge15hcAXZphr8HePiw',
            CLIENT_ID: '611395134102-b0913rahbehjqghfkasgtlfl9ogojneq.apps.googleusercontent.com',
            SPREADSHEET_ID: '1O3QrecIyS2nrc_w6UpRMthFPCQF5MY5s_NFqsylz3w4',
            SHEETS: {
                assets: 'Assets',
                maintenance: 'Maintenance_History',
                testProcedures: 'Test_Procedures',
                testResults: 'Test_Results'
            }
        };
    </script>
    
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <h3 class="center-align">Data Centre Asset Management</h3>
            <p class="center-align">Complete Dashboard with Google Sheets Integration</p>
            <div class="center-align">
                <div id="signInButton" style="display: none;"></div>
                <div id="signOutArea" style="display: none;">
                    <span id="userInfo" class="white-text"></span>
                    <a href="#" id="signOutBtn" class="btn-flat white-text" style="margin-left: 10px;">Sign Out</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Summary Statistics -->
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalAssets">0</div>
                <div class="stat-label">Total Assets</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeAssets">0</div>
                <div class="stat-label">Active Assets</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="maintenanceDue">0</div>
                <div class="stat-label">Maintenance Due</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="criticalAlerts">0</div>
                <div class="stat-label">Critical Alerts</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filter-section">
            <h5>Filter Assets</h5>
            <div class="row" style="align-items: flex-end;">
                <div class="col s12 m3">
                    <select id="statusFilter">
                        <option value="">All Status</option>
                    </select>
                    <label>Status</label>
                </div>
                <div class="col s12 m3">
                    <select id="typeFilter">
                        <option value="">All Types</option>
                    </select>
                    <label>Asset Type</label>
                </div>
                <div class="col s12 m3">
                    <select id="locationFilter">
                        <option value="">All Locations</option>
                    </select>
                    <label>Location</label>
                </div>
                <div class="col s12 m3">
                    <input type="text" id="searchInput" placeholder="Search assets...">
                    <label for="searchInput">Search</label>
                </div>
            </div>
        </div>

        <!-- Assets Grid -->
        <div id="assetsContainer" class="row">
            <div class="loading-spinner">
                <div class="preloader-wrapper big active">
                    <div class="spinner-layer spinner-blue-only">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                            <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                            <div class="circle"></div>
                        </div>
                    </div>
                </div>
                <p>Loading assets...</p>
            </div>
        </div>
    </div>

    <!-- Asset Detail Modal -->
    <div id="assetModal" class="modal modal-fixed-footer" style="width: 90%; max-width: 1200px;">
        <div class="modal-content" style="padding: 0;">
            <div class="asset-info-header">
                <h4 id="assetModalTitle">Asset Details</h4>
                <div id="assetModalBadge" class="asset-info-badge"></div>
            </div>
            
            <ul class="tabs">
                <li class="tab"><a href="#assetInfo" class="active">Asset Info</a></li>
                <li class="tab"><a href="#maintenanceHistory">Maintenance</a></li>
                <li class="tab"><a href="#testProcedures">Test Procedures</a></li>
                <li class="tab"><a href="#testHistory">Test History</a></li>
            </ul>
            
            <div id="assetInfo" class="tab-content">
                <!-- Asset information will be populated here -->
            </div>
            
            <div id="maintenanceHistory" class="tab-content">
                <!-- Maintenance history will be populated here -->
            </div>
            
            <div id="testProcedures" class="tab-content">
                <!-- Test procedures will be populated here -->
            </div>
            
            <div id="testHistory" class="tab-content">
                <!-- Test history will be populated here -->
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
            <a href="#!" class="waves-effect waves-green btn" onclick="updateAssetStatus('In Maintenance')">Update Status</a>
        </div>
    </div>

    <!-- Test Execution Modal -->
    <div id="testModal" class="modal modal-fixed-footer" style="width: 80%; max-width: 1000px;">
        <div class="modal-content">
            <h4 id="testModalTitle">Execute Test Procedure</h4>
            <div id="testContent">
                <!-- Test content will be populated here -->
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
            <a href="#!" class="waves-effect waves-green btn" id="submitTestBtn" onclick="submitTestResults()">Submit Results</a>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <h4>Test Results Summary</h4>
            <div id="resultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="image-container">
                <img id="modalImage" src="" alt="Asset Image">
                <div class="image-controls">
                    <a class="btn-floating" onclick="zoomImage(-0.2)"><i class="material-icons">zoom_out</i></a>
                    <a class="btn-floating" onclick="zoomImage(0.2)"><i class="material-icons">zoom_in</i></a>
                    <a class="btn-floating" onclick="resetZoom()"><i class="material-icons">center_focus_strong</i></a>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat">Close</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        // Google API configuration
        const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let currentUser = null;

        // Global variables
        let allAssets = [];
        let filteredAssets = [];
        let maintenanceHistory = [];
        let testProcedures = [];
        let testResultsHistory = [];
        let currentAsset = null;
        let currentTest = null;
        let testResults = {};
        let currentImageZoom = 1;
        let currentWizardStep = 0;
        let wizardMode = true;

        // Initialize when DOM is loaded - ONLY ONCE
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Materialize components
            var selects = document.querySelectorAll('select');
            M.FormSelect.init(selects);
            
            var modals = document.querySelectorAll('.modal');
            M.Modal.init(modals);
            
            var tabs = document.querySelectorAll('.tabs');
            M.Tabs.init(tabs);
            
            // Add event listeners for filters
            document.getElementById('statusFilter').addEventListener('change', filterAssets);
            document.getElementById('typeFilter').addEventListener('change', filterAssets);
            document.getElementById('locationFilter').addEventListener('change', filterAssets);
            document.getElementById('searchInput').addEventListener('input', filterAssets);
            
            // Initialize Google services after a delay
            setTimeout(() => {
                initializeGoogleServices();
            }, 500);
        });

        // New function to handle Google services initialization
        function initializeGoogleServices() {
            if (typeof gapi !== 'undefined') {
                gapiLoad();
            } else {
                console.warn('Google API not loaded, showing fallback');
                showFallbackButton('Google API failed to load. Click to try manual sign-in.');
            }
            
            if (typeof google !== 'undefined') {
                gisLoad();
            } else {
                console.warn('Google Identity Services not loaded');
                showFallbackButton('Google Identity Services failed to load.');
            }
        }

        // Function to show fallback button
        function showFallbackButton(message) {
            const signInButton = document.getElementById('signInButton');
            signInButton.innerHTML = `
                <p class="white-text" style="margin-bottom: 10px;">${message}</p>
                <a href="#" class="btn blue lighten-1" onclick="handleManualSignIn()">Manual Sign In</a>
            `;
            signInButton.style.display = 'block';
        }

        // New Google Identity Services implementation
        function gapiLoad() {
            gapi.load('api', gapiInit);
        }

        async function gapiInit() {
            try {
                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing Google API:', error);
                showFallbackButton('Failed to initialise Google API. Click for manual sign-in.');
            }
        }

        function gisLoad() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CONFIG.CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        console.log('Token received:', tokenResponse);
                        if (tokenResponse.access_token) {
                            // Set the access token for gapi
                            gapi.client.setToken(tokenResponse);
                            // Verify the token and get user info
                            verifyToken(tokenResponse.access_token);
                        }
                    },
                });
                gisInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing Google Identity Services:', error);
                showFallbackButton('Failed to initialise sign-in. Click for manual access.');
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                renderSignInButton();
            }
        }

        // New function to render sign-in button
        function renderSignInButton() {
            try {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CONFIG.CLIENT_ID,
                    callback: handleCredentialResponse
                });

                google.accounts.id.renderButton(
                    document.getElementById('signInButton'),
                    { 
                        theme: 'outline', 
                        size: 'large',
                        text: 'sign_in_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    }
                );
                
                document.getElementById('signInButton').style.display = 'block';
                
                // Also set up the manual token client as backup
                document.getElementById('signOutBtn').addEventListener('click', handleSignoutClick);
            } catch (error) {
                console.error('Error rendering sign-in button:', error);
                showFallbackButton('Sign-in button failed to render. Click for manual access.');
            }
        }

        async function verifyToken(token) {
            try {
                const response = await fetch(`https://www.googleapis.com/oauth2/v1/userinfo?access_token=${token}`);
                const userInfo = await response.json();
                
                if (userInfo.email) {
                    currentUser = {
                        name: userInfo.name,
                        email: userInfo.email,
                        picture: userInfo.picture
                    };
                    updateUIForSignedIn();
                    await loadAllData();
                } else {
                    throw new Error('Failed to get user info');
                }
            } catch (error) {
                console.error('Error verifying token:', error);
                M.toast({html: 'Failed to verify sign-in. Please try again.', classes: 'red'});
            }
        }

        function handleManualSignIn() {
            if (tokenClient) {
                tokenClient.requestAccessToken();
            } else {
                M.toast({html: 'Sign-in service not available. Using demo data.', classes: 'orange'});
                // Load demo data
                loadDemoData();
            }
        }

        function handleCredentialResponse(response) {
            try {
                const userInfo = decodeJwtResponse(response.credential);
                currentUser = {
                    name: userInfo.name,
                    email: userInfo.email,
                    picture: userInfo.picture
                };
                
                // Now request access token for Sheets API
                if (tokenClient) {
                    tokenClient.requestAccessToken();
                } else {
                    updateUIForSignedIn();
                    loadDemoData();
                }
            } catch (error) {
                console.error('Error handling credential response:', error);
                M.toast({html: 'Sign-in failed. Loading demo data.', classes: 'orange'});
                loadDemoData();
            }
        }

        // Add the missing decodeJwtResponse function
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function updateUIForSignedIn() {
            document.getElementById('signInButton').style.display = 'none';
            document.getElementById('signOutArea').style.display = 'block';
            
            if (currentUser) {
                document.getElementById('userInfo').textContent = `Welcome, ${currentUser.name}`;
            }
        }

        function handleSignoutClick() {
            if (gapi.client.getToken()) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token);
                gapi.client.setToken('');
            }
            
            currentUser = null;
            document.getElementById('signInButton').style.display = 'block';
            document.getElementById('signOutArea').style.display = 'none';
            
            // Clear data
            allAssets = [];
            displayAssets();
            updateStatistics();
        }

        async function loadAllData() {
            try {
                document.querySelector('.loading-spinner').style.display = 'block';
                
                await Promise.all([
                    loadAssets(),
                    loadMaintenanceHistory(),
                    loadTestProcedures(),
                    loadTestResults()
                ]);
                
                updateStatistics();
                populateFilters();
                displayAssets();
                
                document.querySelector('.loading-spinner').style.display = 'none';
                M.toast({html: 'Data loaded successfully!', classes: 'green'});
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.loading-spinner').style.display = 'none';
                M.toast({html: 'Failed to load data. Using demo data.', classes: 'orange'});
                loadDemoData();
            }
        }

        async function loadAssets() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                    range: `${GOOGLE_CONFIG.SHEETS.assets}!A:Z`,
                });
                
                const rows = response.result.values;
                if (rows && rows.length > 1) {
                    const headers = rows[0];
                    allAssets = rows.slice(1).map(row => {
                        const asset = {};
                        headers.forEach((header, index) => {
                            asset[header.toLowerCase().replace(/\s+/g, '_')] = row[index] || '';
                        });
                        return asset;
                    });
                }
            } catch (error) {
                console.error('Error loading assets:', error);
                throw error;
            }
        }

        async function loadMaintenanceHistory() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                    range: `${GOOGLE_CONFIG.SHEETS.maintenance}!A:Z`,
                });
                
                const rows = response.result.values;
                if (rows && rows.length > 1) {
                    const headers = rows[0];
                    maintenanceHistory = rows.slice(1).map(row => {
                        const record = {};
                        headers.forEach((header, index) => {
                            record[header.toLowerCase().replace(/\s+/g, '_')] = row[index] || '';
                        });
                        return record;
                    });
                }
            } catch (error) {
                console.error('Error loading maintenance history:', error);
            }
        }

        async function loadTestProcedures() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                    range: `${GOOGLE_CONFIG.SHEETS.testProcedures}!A:Z`,
                });
                
                const rows = response.result.values;
                if (rows && rows.length > 1) {
                    const headers = rows[0];
                    testProcedures = rows.slice(1).map(row => {
                        const procedure = {};
                        headers.forEach((header, index) => {
                            procedure[header.toLowerCase().replace(/\s+/g, '_')] = row[index] || '';
                        });
                        return procedure;
                    });
                }
            } catch (error) {
                console.error('Error loading test procedures:', error);
            }
        }

        async function loadTestResults() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                    range: `${GOOGLE_CONFIG.SHEETS.testResults}!A:Z`,
                });
                
                const rows = response.result.values;
                if (rows && rows.length > 1) {
                    const headers = rows[0];
                    testResultsHistory = rows.slice(1).map(row => {
                        const result = {};
                        headers.forEach((header, index) => {
                            result[header.toLowerCase().replace(/\s+/g, '_')] = row[index] || '';
                        });
                        return result;
                    });
                }
            } catch (error) {
                console.error('Error loading test results:', error);
            }
        }

        function loadDemoData() {
            // Demo asset data
            allAssets = [
                {
                    asset_id: 'server-001',
                    asset_name: 'Server-001',
                    asset_type: 'Dell PowerEdge R740',
                    location: 'Rack A01, U10-U12',
                    status: 'Normal',
                    last_maintenance: '2024-07-15',
                    serial_number: 'DPR740001',
                    warranty_expires: '2026-12-31',
                    specifications: 'CPU: Intel Xeon Gold 6230, RAM: 64GB DDR4, Storage: 2TB SSD RAID1, Network: 4x 1GbE, 2x 10GbE'
                },
                {
                    asset_id: 'cooling-001',
                    asset_name: 'HVAC-001',
                    asset_type: 'Cooling System',
                    location: 'Utility Room',
                    status: 'In Maintenance',
                    last_maintenance: '2024-06-01',
                    serial_number: 'HVAC001',
                    warranty_expires: '2025-06-30',
                    specifications: 'Capacity: 50 tons, Power: 380V 3-phase, Coolant: R-410A, Control: Digital thermostat'
                },
                {
                    asset_id: 'switch-001',
                    asset_name: 'Switch-001',
                    asset_type: 'Cisco Nexus 9000',
                    location: 'Rack B01, U1-U2',
                    status: 'Normal',
                    last_maintenance: '2024-08-01',
                    serial_number: 'CSC9K001',
                    warranty_expires: '2027-03-15',
                    specifications: 'Ports: 48x 10GbE, 4x 40GbE, Switching Capacity: 1.28 Tbps, Power: Dual 350W PSU, OS: NX-OS 9.3'
                }
            ];
            
            updateStatistics();
            populateFilters();
            displayAssets();
            document.querySelector('.loading-spinner').style.display = 'none';
        }

        function updateStatistics() {
            const totalAssets = allAssets.length;
            const activeAssets = allAssets.filter(asset => asset.status === 'Normal').length;
            const maintenanceDue = allAssets.filter(asset => getMaintenanceStatus(asset) !== 'current').length;
            const criticalAlerts = allAssets.filter(asset => asset.status === 'Fault/Shutdown' || asset.status === 'Critical').length;
            
            document.getElementById('totalAssets').textContent = totalAssets;
            document.getElementById('activeAssets').textContent = activeAssets;
            document.getElementById('maintenanceDue').textContent = maintenanceDue;
            document.getElementById('criticalAlerts').textContent = criticalAlerts;
        }

        function populateFilters() {
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const locationFilter = document.getElementById('locationFilter');
            
            // Clear existing options (except "All")
            statusFilter.innerHTML = '<option value="">All Status</option>';
            typeFilter.innerHTML = '<option value="">All Types</option>';
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            
            // Get unique values
            const statuses = [...new Set(allAssets.map(asset => asset.status))];
            const types = [...new Set(allAssets.map(asset => asset.asset_type))];
            const locations = [...new Set(allAssets.map(asset => asset.location))];
            
            // Populate dropdowns
            statuses.forEach(status => {
                if (status) {
                    statusFilter.innerHTML += `<option value="${status.toLowerCase()}">${status}</option>`;
                }
            });
            
            types.forEach(type => {
                if (type) {
                    typeFilter.innerHTML += `<option value="${type.toLowerCase()}">${type}</option>`;
                }
            });
            
            locations.forEach(location => {
                if (location) {
                    locationFilter.innerHTML += `<option value="${location.toLowerCase()}">${location}</option>`;
                }
            });
            
            // Reinitialize Materialize selects
            M.FormSelect.init(document.querySelectorAll('select'));
        }

        function filterAssets() {
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            filteredAssets = allAssets.filter(asset => {
                const statusMatch = !statusFilter || (asset.status && asset.status.toLowerCase().includes(statusFilter));
                const typeMatch = !typeFilter || (asset.asset_type && asset.asset_type.toLowerCase().includes(typeFilter));
                const locationMatch = !locationFilter || (asset.location && asset.location.toLowerCase().includes(locationFilter));
                const searchMatch = !searchInput || 
                    (asset.asset_name && asset.asset_name.toLowerCase().includes(searchInput)) ||
                    (asset.asset_type && asset.asset_type.toLowerCase().includes(searchInput)) ||
                    (asset.location && asset.location.toLowerCase().includes(searchInput)) ||
                    (asset.serial_number && asset.serial_number.toLowerCase().includes(searchInput));
                
                return statusMatch && typeMatch && locationMatch && searchMatch;
            });
            
            displayAssets();
        }

        function getMaintenanceStatus(asset) {
            if (!asset.last_maintenance) return 'overdue';
            
            const lastMaintenance = parseDate(asset.last_maintenance);
            const now = new Date();
            const daysSinceLastMaintenance = Math.floor((now - lastMaintenance) / (1000 * 60 * 60 * 24));
            
            if (daysSinceLastMaintenance > 365) return 'overdue';
            if (daysSinceLastMaintenance > 300) return 'due_soon';
            return 'current';
        }

        function parseDate(dateStr) {
            return new Date(dateStr);
        }

        function displayAssets() {
            const container = document.getElementById('assetsContainer');
            const assetsToShow = filteredAssets.length > 0 ? filteredAssets : allAssets;
            
            if (assetsToShow.length === 0) {
                container.innerHTML = `
                    <div class="col s12">
                        <div class="card-panel center-align">
                            <i class="material-icons large grey-text">storage</i>
                            <h5>No Assets Found</h5>
                            <p>No assets match your current filters or no data is loaded.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            assetsToShow.forEach((asset, index) => {
                const maintenanceStatus = getMaintenanceStatus(asset);
                const statusClass = asset.status ? asset.status.toLowerCase().replace(/[^a-z]/g, '-') : 'unknown';
                const cardClass = maintenanceStatus === 'overdue' ? 'maintenance-overdue' : 
                                 maintenanceStatus === 'due_soon' ? 'maintenance-due-soon' : '';
                
                const badgeHtml = maintenanceStatus === 'overdue' ? 
                    '<div class="maintenance-badge overdue"><i class="material-icons">error</i>Maintenance Overdue</div>' :
                    maintenanceStatus === 'due_soon' ? 
                    '<div class="maintenance-badge due-soon"><i class="material-icons">warning</i>Maintenance Due Soon</div>' : '';
                
                html += `
                    <div class="col s12 m6 l4">
                        <div class="asset-card card ${cardClass}" onclick="showAssetDetails('${asset.asset_id}')" style="animation-delay: ${index * 0.1}s;">
                            <div class="card-content">
                                <span class="card-title">${asset.asset_name || 'Unknown Asset'}</span>
                                <p><strong>Type:</strong> ${asset.asset_type || 'Unknown'}</p>
                                <p><strong>Location:</strong> ${asset.location || 'Unknown'}</p>
                                <p><strong>Status:</strong> <span class="status-${statusClass}">${asset.status || 'Unknown'}</span></p>
                                <p><strong>Last Maintenance:</strong> ${asset.last_maintenance || 'Never'}</p>
                                ${badgeHtml}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showAssetDetails(assetId) {
            currentAsset = allAssets.find(asset => asset.asset_id === assetId);
            if (!currentAsset) {
                M.toast({html: 'Asset not found!', classes: 'red'});
                return;
            }
            
            document.getElementById('assetModalTitle').textContent = currentAsset.asset_name;
            document.getElementById('assetModalBadge').textContent = currentAsset.status || 'Unknown Status';
            
            // Show asset info by default
            showAssetInfo();
            
            // Initialize tabs
            const modal = M.Modal.getInstance(document.getElementById('assetModal'));
            modal.open();
            
            // Initialize tabs after modal opens
            setTimeout(() => {
                const tabs = M.Tabs.init(document.querySelectorAll('.tabs'));
            }, 100);
        }

        function showAssetInfo() {
            const container = document.getElementById('assetInfo');
            const asset = currentAsset;
            
            const statusClass = asset.status ? asset.status.toLowerCase().replace(/[^a-z]/g, '-') : 'unknown';
            
            container.innerHTML = `
                <div class="info-card">
                    <h6>Basic Information</h6>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Asset ID</div>
                            <div class="info-value">${asset.asset_id || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Asset Type</div>
                            <div class="info-value">${asset.asset_type || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Location</div>
                            <div class="info-value">${asset.location || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Serial Number</div>
                            <div class="info-value">${asset.serial_number || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Status</div>
                            <div class="info-value"><span class="status-${statusClass}">${asset.status || 'Unknown'}</span></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Last Maintenance</div>
                            <div class="info-value">${asset.last_maintenance || 'Never'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Warranty Expires</div>
                            <div class="info-value">${asset.warranty_expires || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h6>Specifications</h6>
                    <p>${asset.specifications || 'No specifications available'}</p>
                </div>
                
                <div class="info-card">
                    <h6>Recent Activity</h6>
                    <div class="collection">
                        <div class="collection-item">
                            <span class="title">Last Maintenance</span>
                            <p>Date: ${asset.last_maintenance || 'Never'}<br>
                            Status: ${getMaintenanceStatus(asset)}</p>
                        </div>
                        <div class="collection-item">
                            <span class="title">System Status Check</span>
                            <p>Performed: ${new Date().toLocaleDateString()}<br>
                            Result: All systems nominal</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showMaintenanceHistory() {
            const container = document.getElementById('maintenanceHistory');
            const assetMaintenanceHistory = maintenanceHistory.filter(record => 
                record.asset_id === currentAsset.asset_id
            );
            
            let html = `
                <div class="row">
                    <div class="col s12">
                        <div class="right-align">
                            <a class="btn blue" onclick="openLogMaintenanceModal()">
                                <i class="material-icons left">add</i>Log Maintenance
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            if (assetMaintenanceHistory.length === 0) {
                html += `
                    <div class="center-align">
                        <i class="material-icons large grey-text">build</i>
                        <h6>No Maintenance History</h6>
                        <p>No maintenance records found for this asset.</p>
                    </div>
                `;
            } else {
                assetMaintenanceHistory.forEach(record => {
                    html += `
                        <div class="maintenance-card">
                            <div class="maintenance-type ${record.maintenance_type || 'routine'}">${record.maintenance_type || 'Routine'}</div>
                            <h6>${record.maintenance_title || 'Maintenance'}</h6>
                            <p><strong>Date:</strong> ${record.maintenance_date}</p>
                            <p><strong>Performed by:</strong> ${record.technician_name}</p>
                            <p><strong>Duration:</strong> ${record.duration || 'N/A'}</p>
                            <p><strong>Description:</strong> ${record.description || 'No description'}</p>
                            ${record.notes ? `<p><strong>Notes:</strong> ${record.notes}</p>` : ''}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }
        
        // Open log maintenance modal
        window.openLogMaintenanceModal = function() {
            const modal = M.Modal.getInstance(document.getElementById('logMaintenanceModal'));
            modal.open();
            
            // Set today's date as default
            document.getElementById('maintenanceDate').value = new Date().toISOString().split('T')[0];
        }

        // Submit maintenance log
        window.submitMaintenanceLog = async function() {
            const form = document.getElementById('maintenanceForm');
            if (!form.checkValidity()) {
                M.toast({html: 'Please fill in all required fields', classes: 'red'});
                return;
            }
            
            const maintenanceRecord = {
                asset_id: currentAsset.asset_id,
                maintenance_date: document.getElementById('maintenanceDate').value,
                maintenance_type: document.getElementById('maintenanceType').value,
                technician_name: document.getElementById('technicianName').value,
                duration: document.getElementById('maintenanceDuration').value,
                maintenance_title: document.getElementById('maintenanceTitle').value,
                description: document.getElementById('maintenanceDescription').value,
                notes: document.getElementById('maintenanceNotes').value,
                logged_by: currentUser ? currentUser.name : 'Unknown',
                logged_at: new Date().toISOString()
            };
            
            try {
                // Add to local array
                maintenanceHistory.push(maintenanceRecord);
                
                // Update asset's last maintenance date
                currentAsset.last_maintenance = maintenanceRecord.maintenance_date;
                
                M.toast({html: 'Maintenance logged successfully!', classes: 'green'});
                
                // Close modal and refresh view
                const modal = M.Modal.getInstance(document.getElementById('logMaintenanceModal'));
                modal.close();
                form.reset();
                
                // Refresh maintenance history display
                showMaintenanceHistory();
                
                // Update statistics
                updateStatistics();
                displayAssets();
                
            } catch (error) {
                console.error('Error logging maintenance:', error);
                M.toast({html: 'Failed to log maintenance. Please try again.', classes: 'red'});
            }
        }

        function showTestProcedures() {
            const container = document.getElementById('testProcedures');
            const assetTestProcedures = testProcedures.filter(procedure => 
                procedure.applicable_asset_types && 
                procedure.applicable_asset_types.toLowerCase().includes(currentAsset.asset_type.toLowerCase())
            );
            
            if (assetTestProcedures.length === 0) {
                container.innerHTML = `
                    <div class="center-align">
                        <i class="material-icons large grey-text">assignment</i>
                        <h6>No Test Procedures</h6>
                        <p>No test procedures are available for this asset type.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            assetTestProcedures.forEach(procedure => {
                html += `
                    <div class="procedure-card">
                        <div class="card-title">${procedure.procedure_name}</div>
                        <div class="procedure-meta">
                            <div class="meta-item">
                                <i class="material-icons">schedule</i>
                                <span>Est. ${procedure.estimated_duration || 'Unknown'}</span>
                            </div>
                            <div class="meta-item">
                                <i class="material-icons">priority_high</i>
                                <span>${procedure.priority || 'Normal'} Priority</span>
                            </div>
                        </div>
                        <p>${procedure.description || 'No description available'}</p>
                        <div class="right-align">
                            <a class="btn blue" onclick="startTest('${procedure.procedure_id}')">
                                <i class="material-icons left">play_arrow</i>Start Test
                            </a>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showTestHistory() {
            const container = document.getElementById('testHistory');
            const assetTestHistory = testResultsHistory.filter(result => 
                result.asset_id === currentAsset.asset_id
            );
            
            if (assetTestHistory.length === 0) {
                container.innerHTML = `
                    <div class="center-align">
                        <i class="material-icons large grey-text">history</i>
                        <h6>No Test History</h6>
                        <p>No test results found for this asset.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="test-timeline">';
            assetTestHistory.forEach(result => {
                const resultClass = result.overall_result === 'Passed' ? 'passed' : 'failed';
                html += `
                    <div class="timeline-item ${resultClass}">
                        <div class="timeline-content">
                            <h6>${result.procedure_name}</h6>
                            <p><strong>Result:</strong> <span class="status-${resultClass}">${result.overall_result}</span></p>
                            <p><strong>Date:</strong> ${result.test_date}</p>
                            <p><strong>Performed by:</strong> ${result.performed_by}</p>
                            <p><strong>Duration:</strong> ${result.test_duration || 'N/A'}</p>
                            ${result.notes ? `<p><strong>Notes:</strong> ${result.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Test execution functions
        function startTest(procedureId) {
            currentTest = testProcedures.find(p => p.procedure_id === procedureId);
            if (!currentTest) {
                M.toast({html: 'Test procedure not found!', classes: 'red'});
                return;
            }
            
            // Reset test state
            testResults = {};
            currentWizardStep = 0;
            
            // Show test modal
            document.getElementById('testModalTitle').textContent = `Execute: ${currentTest.procedure_name}`;
            
            const modal = M.Modal.getInstance(document.getElementById('testModal'));
            modal.open();
        }

        // Submit test results function
        async function submitTestResults() {
            try {
                const overallResult = Object.values(testResults).some(r => r.result === 'fail') ? 'Failed' : 'Passed';
                
                const testRecord = {
                    asset_id: currentAsset.asset_id,
                    procedure_id: currentTest.procedure_id,
                    procedure_name: currentTest.procedure_name,
                    test_date: new Date().toISOString().split('T')[0],
                    overall_result: overallResult,
                    submitted_by: currentUser ? currentUser.name : 'Unknown',
                    submitted_at: new Date().toISOString()
                };
                
                // Add to local array
                testResultsHistory.push(testRecord);
                
                // Close test modal
                const testModal = M.Modal.getInstance(document.getElementById('testModal'));
                testModal.close();
                
                // Refresh test history
                showTestHistory();
                
                M.toast({html: 'Test results submitted successfully!', classes: 'green'});
                
            } catch (error) {
                console.error('Error submitting test results:', error);
                M.toast({html: 'Failed to submit test results. Please try again.', classes: 'red'});
            }
        }
    </script>
</body>
</html>
